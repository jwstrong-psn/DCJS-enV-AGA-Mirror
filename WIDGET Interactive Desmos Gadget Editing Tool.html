<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>AGA WIDGET</title>
  <link href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
  <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src='./cloudinary/jquery.ui.widget.js' type='text/javascript'></script>
  <script src='./cloudinary/jquery.iframe-transport.js' type='text/javascript'></script>
  <script src='./cloudinary/jquery.fileupload.js' type='text/javascript'></script>
  <script src='./cloudinary/jquery.cloudinary.js' type='text/javascript'></script>
  <!--script src="https://www.desmos.com/api/v1.0/geometry.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script-->
  <script src="./desmos/geometry.2018-05-01.js"></script>
  <!--script src="https://www.desmos.com/api/v1.0/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script-->
  <script src="./desmos/calculator.2018-05-01.js"></script>
  <script src="./Desmos AGA Root SCO CJS.js"></script>
  <script src="./Desmos AGA Root SCO CJS Test Master SCO CJS.js"></script>
  <script src="./Desmos Helper Functions.js"></script>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
    }
    #calculator {
      width: 550px;
      height: 450px;
    });
  </style>
</head>
<body>
  <table>
    <tr>
      <td colspan="2" style="vertical-align:top;">
        <div id="frame"><div id="calculator"></div></div>
      </td>
      <td rowspan="4" style="vertical-align:top;text-align:center">
        <button type="button" id="graphing" style="background:green;color:white;">Calculator</button>&nbsp;<button type="button" id="geometry" style="background:red;color:white;">Geometry</button><br>
        <div id="calcConstructorButtons">
        <table>
          <tr><td style="text-align:right">Keypad: </td><td style="text-align:center"><button type="button" id="keypad">?</button></td></tr>
          <tr><td style="text-align:right">Graph Paper: </td><td style="text-align:center"><button type="button" id="graphpaper">?</button></td></tr>
          <tr><td style="text-align:right">Expressions: </td><td style="text-align:center"><button type="button" id="expressions">?</button></td></tr>
          <tr><td style="text-align:right">Settings Menu: </td><td style="text-align:center"><button type="button" id="settingsMenu">?</button></td></tr>
          <tr><td style="text-align:right">Zoom Buttons: </td><td style="text-align:center"><button type="button" id="zoomButtons">?</button></td></tr>
          <tr><td style="text-align:right">Expressions Top Bar: </td><td style="text-align:center"><button type="button" id="expressionsTopbar">?</button></td></tr>
          <tr><td style="text-align:right">Points of Interest: </td><td style="text-align:center"><button type="button" id="pointsOfInterest">?</button></td></tr>
          <tr><td style="text-align:right">Trace: </td><td style="text-align:center"><button type="button" id="trace">?</button></td></tr>
          <tr><td style="text-align:right">Border: </td><td style="text-align:center"><button type="button" id="border">?</button></td></tr>
          <tr><td style="text-align:right">Lock Viewport: </td><td style="text-align:center"><button type="button" id="lockViewport">?</button></td></tr>
          <tr><td style="text-align:right">Expressions Collapsed: </td><td style="text-align:center"><button type="button" id="expressionsCollapsed">?</button></td></tr>
          <tr><td style="text-align:right">Administer Secret Folders: </td><td style="text-align:center"><button type="button" id="administerSecretFolders">?</button></td></tr>
          <tr><td style="text-align:right">Images: </td><td style="text-align:center"><button type="button" id="images">?</button></td></tr>
          <tr><td style="text-align:right">Folders: </td><td style="text-align:center"><button type="button" id="folders">?</button></td></tr>
          <tr><td style="text-align:right">Notes: </td><td style="text-align:center"><button type="button" id="notes">?</button></td></tr>
          <tr><td style="text-align:right">QWERTY Keyboard: </td><td style="text-align:center"><button type="button" id="qwertyKeyboard">?</button></td></tr>
          <tr><td style="text-align:right">Restricted Functions: </td><td style="text-align:center"><button type="button" id="restrictedFunctions">?</button></td></tr>
          <tr><td style="text-align:right">Paste Graph Link: </td><td style="text-align:center"><button type="button" id="pasteGraphLink">?</button></td></tr>
          <tr><td style="text-align:right">Paste Table Data: </td><td style="text-align:center"><button type="button" id="pasteTableData">?</button></td></tr>
          <tr><td style="text-align:right">Degree Mode: </td><td style="text-align:center"><button type="button" id="degreeMode">?</button></td></tr>
        </table>
        </div>
        <div id="geoConstructorButtons">
        <table>
          <tr><td style="text-align:right">Construct Angle: </td><td style="text-align:center"><button type="button" id="constructAngle">?</button></td></tr>
          <tr><td style="text-align:right">Construct Perpendicular Line: </td><td style="text-align:center"><button type="button" id="constructPerpendicular">?</button></td></tr>
          <tr><td style="text-align:right">Construct Parallel Line: </td><td style="text-align:center"><button type="button" id="constructParallel">?</button></td></tr>
          <tr><td style="text-align:right">Construct Midpoint: </td><td style="text-align:center"><button type="button" id="constructMidpoint">?</button></td></tr>
          <tr><td style="text-align:right">Construct Compass: </td><td style="text-align:center"><button type="button" id="constructCompass">?</button></td></tr>
          <tr><td style="text-align:right">Border: </td><td style="text-align:center"><button type="button" id="geoBorder">?</button></td></tr>
          <tr><td style="text-align:right">Header Bar: </td><td style="text-align:center"><button type="button" id="headerbar">?</button></td></tr>
          <tr><td style="text-align:right">Settings Menu: </td><td style="text-align:center"><button type="button" id="geoSettings">?</button></td></tr>
          <tr><td style="text-align:right">Undo/Redo Icons: </td><td style="text-align:center"><button type="button" id="geoUndo">?</button></td></tr>
          <tr><td style="text-align:right">Sidebar: </td><td style="text-align:center"><button type="button" id="sidebar">?</button></td></tr>
          <tr><td style="text-align:right">Autosize: </td><td style="text-align:center"><button type="button" id="geoAutosize">?</button></td></tr>
          <tr><td style="text-align:right">Selection: </td><td style="text-align:center"><button type="button" id="selection">?</button></td></tr>
          <tr><td style="text-align:right">Ruler: </td><td style="text-align:center"><button type="button" id="ruler">?</button></td></tr>
          <tr><td style="text-align:right">Protractor: </td><td style="text-align:center"><button type="button" id="protractor">?</button></td></tr>
          <tr><td colspan="2">EXPERIMENTAL:</td></tr>
          <tr><td style="text-align:right">Custom Tools: </td><td style="text-align:center"><button type="button" id="customtools">?</button></td></tr>
        </table>
        </div>
        <div id="commonConstructorButtons" style="text-align:right">
          <button type="button" id="defaultConstructors">Reset to Defaults</button><br>
          <button type="button" id="clearConstructors">Clear All</button><br>
          <button type="button" id="saveConstructors">Export</button><br>
          <input type="text" id="constructorInput" placeholder="Custom list…"><br>
          <button type="button" id="onlyConstructors">Enable Entered &amp;<br>Disable Others</button>
          <button type="button" id="changeConstructors">Make Entered<br>Changes Only</button>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan="2" align="right">
        <div id="warning"></div>
      </td>
    </tr>
    <tr height="100%">
      <td style="vertical-align:top">
        <button type="button" id="copyState">Copy Current State</button><br>
        <button type="button" id="download">Download Current State</button><br>
        <button type="button" id="save">Save As New Widget</button><br>
        <input type="text" id="stateInput" placeholder="Paste state here…">
        <button type="button" id="load">Load State</button>
      </td>
      <td style="vertical-align:top">
        <table style="float:right">
          <tr>
            <td>
              <input type="text" id="desWidth" placeholder="w" style="width:3em;text-align:center">px
            </td>
            <td rowspan="2" style="vertical-align:top">×</td>
            <td style="vertical-align:top;">
              <input type="text" id="desHeight" placeholder="h" style="width:3em;text-align:center">px
            </td>
          </tr>
          <tr>
            <td style="vertical-align:top">
              <button type="button" id="w280" style="width:3em;">1/3</button><br>
              <button type="button" id="w415" style="width:3em;">50%</button><br>
              <button type="button" id="w550" style="width:3em;">2/3</button><br>
              <button type="button" id="w860" style="width:3em;">Full</button>
            </td>
            <td style="vertical-align:top">
              <button type="button" id="h350" style="width:3em;">350</button><br>
              <button type="button" id="h400" style="width:3em;">400</button><br>
              <button type="button" id="h475" style="width:3em;">475</button><br>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <div id="saveBrowserDiv" style="overflow-x:scroll;">
          <table>
            <tr id="saveBrowserRow">
            </tr>
          </table>
        </div>
      </td>
    </tr>
    <tr style="border:1px solid;">
      <td colspan="3">
        <div id="sliders">
          <table>
          <thead>
            <tr><th>Slider ID</th><th>Variable Name</th><th>Function Name</th><th>Value</th></tr>
          </thead>
          <tbody id="sliderList">
            <tr id="newSlider">
              <td><input type="text" class="sliderId" placeholder="Id…"></td>
              <td><input type="text" class="sliderVar" placeholder="Variable…"></td>
              <td><input type="text" class="sliderFunc" placeholder="Function…"></td>
              <td><input type="text" class="sliderVal" placeholder="Value…"></td>
              <td><button type="button" class="addSlider">Add</button></td>
              <td><button type="button" class="deleteSlider">Clear</button></td>
            </tr>
          </tbody>
          </table>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan="3">
        <div id="helperExpressions" style="min-height:150px;">
          <table>
          <thead>
            <tr><th>Expression</th><th>Function Name</th><th>Value</th></tr>
          </thead>
          <tbody id="helperList">
            <tr id="newHelper">
              <td><input type="text" class="helperName" placeholder="Expression…"></td>
              <td><input type="text" class="helperFunction" placeholder="Function⁢…"></td>
              <td><input type="text" class="helperValue" placeholder="Value⁢…"></td>
              <td><button type="button" class="addHelper">Add</button></td>
              <td><button type="button" class="deleteHelper">Clear</button></td>
            </tr>
          </tbody>
          </table>
          <div id="bottomPadding" style="height:50px"></div>
        </div>
      </td>
    </tr>
  </table>
  <script>
    $(function() {

      /* ←— objKeys —————————————————————————————————————————————————→ *\
       | replaces Object.keys in case of *shudder* IE
       * ←————————————————————————————————————————————————————————————————→ */
       var objKeys = (function(){
        if(typeof Object.keys === "function"){
          return Object.keys;
        } else {
          // From https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/keys
          return (function () {
            var hasOwnProperty = Object.prototype.hasOwnProperty,
            hasDontEnumBug = !({toString: null}).propertyIsEnumerable('toString'),
            dontEnums = [
              'toString',
              'toLocaleString',
              'valueOf',
              'hasOwnProperty',
              'isPrototypeOf',
              'propertyIsEnumerable',
              'constructor'
            ],
            dontEnumsLength = dontEnums.length;

            return function (obj) {
              if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
                throw new TypeError('Object.keys called on non-object');
              }

              var result = [], prop, i;

              for (prop in obj) {
                if (hasOwnProperty.call(obj, prop)) {
                  result.push(prop);
                }
              }

              if (hasDontEnumBug) {
                for (i = 0; i < dontEnumsLength; i++) {
                  if (hasOwnProperty.call(obj, dontEnums[i])) {
                    result.push(dontEnums[i]);
                  }
                }
              }
              return result;
            };
          }());
        }
       })();

      /* ←— mergeObjects —————————————————————————————————————————————————→ *\
       | replaces Object.assign in case of *shudder* IE
       * ←————————————————————————————————————————————————————————————————→ */
       var mergeObjects = (function() {
        if (typeof Object.assign === "function") {
          return Object.assign;
        } else {
          return function(){
            var obj = arguments[0];

            [].forEach.call(arguments, function(arg,i) {
              var keys = [];
              if(typeof arg === "string") {
                while(keys.length < arg.length) {
                  keys.push(keys.length);
                }
              } else {
                keys = objKeys(arg);
              }

              if(i > 0) {
                keys.forEach(function(key) {
                  obj[key] = arg[key];
                });
              }
            });

            return obj;
          };
        }
       })();

      window.debugLog = console.log;

      // CLOUDINARY INTEGRATION STUFF
      var cloudinaryUpload = false;

      if($.cloudinary && Object.keys) {
        $.cloudinary.config({ cloud_name: 'jwstrong-psn', api_key: '323322785131496'});

        $(function() {
          if($.fn.cloudinary_fileupload !== undefined) {
            $("input.cloudinary-fileupload[type=file]").cloudinary_fileupload();
          }
        });
        cloudinaryUpload = $.cloudinary.unsigned_upload_tag('eyycjxcx');
      } else {
        console.log("No cloudinary image upload available.");
      }


      // unsigned upload tag = eyycjxcx
      // cloud_name = jwstrong-psn

      /*
        var steve = $.cloudinary.unsigned_upload_tag('eyycjxcx');
        steve.fileupload('option','formData').file = calculator.screenshot()
        steve.bind('fileuploaddone',function(e,g){console.log(g.result.url);})
        steve.fileupload('add', { files: [ data ] })
        });
      */

      // idea from https://github.com/cloudinary/cloudinary_js/issues/78


      // uploadImage(data, cb, done_function):
      //
      // cb will be called when the image is uploaded (usually updateStorage)
      //
      // done_function is a function to execute when all images
      // are uploaded.
      var uploadImage = (function() {
        var imageQueue = [];
        var done_functions = [];
        var processing = false;

        if(!cloudinaryUpload) {
          return (function(msg){
            return function() {
              throw new Error(msg);
            };
          })("Cannot upload image—no target database, or database inaccessible."+
             ((window.location.href.startsWith("file")) ? "You may need to enable CORS for your browser. In Chrome, add \"--allow-file-access-from-files\" to the command line to enable." : "")
          );
        }

        function next() {
          processing = true;
          var image = imageQueue.pop();
          console.log("Saving image; "+(imageQueue.length)+" remain.");

          if(typeof image.cb !== "function") {
            if(imageQueue.length > 0) setTimeout(next,0);
            throw new Error("Upload Error: "+image.data+" cannot be uploaded, because "+image.cb+" is not a function.");
          } else {
            cloudinaryUpload.one('fileuploaddone',function(e,data){
              var func;
              if(typeof image.cb === "function") image.cb(e,data);
              if(imageQueue.length > 0) {
                // console.log("Image saved. Next…");
                next();
              } else {
                console.log("Done saving images.")
                processing = false;
                while(done_functions.length > 0) {
                  func = done_functions.pop();
                  if(typeof func === "function") {
                    console.log("Executing done function:",func);
                    func();
                  } else throw new Error("Upload Error: "+func+" is not a function.");
                }
              }
            });

            cloudinaryUpload.fileupload('option','formData').file = image.data;
            cloudinaryUpload.fileupload('add', { files: [ image.data ] });
          }
        }

        return function(data,cb,done_function) {
          if(typeof data === "string") {
            if(typeof cb !== "function") {
              throw new Error("Upload Error: "+data+" cannot be uploaded, because "+cb+" is not a function.");
            } else {
              // Add the image to the queue
              imageQueue.unshift({data:data,cb:cb});

              if(processing === false) {
                processing = true;
                setTimeout(next,0);
              }
            }
          }
          // Add the done-function, but
          // Don't do the same done_function multiple times
          var alreadyDoing = false;
          if(typeof done_function === "function") {
            done_functions.forEach(function(e){if(e === done_function) alreadyDoing = true;});
            if(alreadyDoing === false) {
              if(processing === true) {
                done_functions.unshift(done_function);
              } else {
                done_function();
              }
            }
          } else if(done_function !== undefined) {
            throw new Error("Upload Error: "+done_function+" is not a function.");
          }
        }
      }());

      // END CLOUDINARY INTEGRATION STUFF

      function shortenImageData(data){
        if(data.length > 80) {
          data = data.slice(0,50)+'...'+data.slice(-27);
        }
        return data;
      }

      // Taken from stackoverflow.com/questions/6150289/
      function toDataURL(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function() {
          var reader = new FileReader();
          reader.onloadend = function() {
            callback(reader.result);
          }
          reader.readAsDataURL(xhr.response);
        };
        xhr.open('GET', url);
        xhr.responseType = 'blob';
        xhr.send();
      }

      // Run a function (cb) on all image data for a package of images
      // When done, execute a function
      window.getImageData = function(images, cb, done) {
        var queue = {};

        objKeys(images).forEach(function(key){
          var image = images[key];
          if(image.data === undefined) {
            if(image.url !== undefined) {
              queue[key] = {
                image:image,
                cb:(function(key,image){return function(image_data){
                  cb(image_data,image);
                  delete queue[key];
                  if(objKeys(queue).length === 0 && typeof done === "function") done();
                };}(key,image))
              };
            } else {
              console.log("Cannot get image data for image without URL:",image);
            }
          } else {
            cb(image.data,image);
          }
        });

        objKeys(queue).forEach(function(key){
          toDataURL(queue[key].image.url.replace("upload/t_FPO","upload"),queue[key].cb);
        });
      }


      var onbuttoncolor = "green";
      var ontextcolor = "white";
      var offbuttoncolor = "red";
      var offtextcolor = "white";
      const DOM_ID_PREFIX = "dom_guid_";
      window.AUTO_SAVE_INTERVAL = 5000;
      const LOADING_TIME_ALLOTMENT = 2500;
      var previewHeight = 100;
      var previewWidth = 100;
      var $checkWarnGui = $('<div style="width:'+previewWidth+'px;"><p id="checkWarn"></p><button type="button" id="checkConfirm"></button><br><button type="button" id="checkCancel"></button></div>');
      var domIdIndex = 0;
      var newSlider;
      var newHelper;

      $("#help").hide();
      $("#geoConstructorButtons").hide();
      $("#hide").click(function(){
        $("#help").hide();
        $("#show").show();
      });
      $("#show").click(function(){
        $("#show").hide();
        $("#help").show();
      });
      $("#graphing").click(function(){
        $("#geoConstructorButtons").hide();
        $("#calcConstructorButtons").show();
        $("#graphing").css("background",onbuttoncolor);
        $("#graphing").css("color",ontextcolor);
        $("#geometry").css("background",offbuttoncolor);
        $("#geometry").css("color",offtextcolor);
        toolType = "graphing";
        window.rebuild();
      });
      $("#geometry").click(function(){
        $("#calcConstructorButtons").hide();
        $("#geoConstructorButtons").show();
        $("#graphing").css("background",offbuttoncolor);
        $("#graphing").css("color",offtextcolor);
        $("#geometry").css("background",onbuttoncolor);
        $("#geometry").css("color",ontextcolor);
        toolType = "geometry";
        window.rebuild();
      });
      constructorButtons: {
        $("#keypad").click(function(){
          window.rebuild({keypad:!(window.currentCalcConstructors.keypad)});
        });
        $("#graphpaper").click(function(){
          window.rebuild({graphpaper:!(window.currentCalcConstructors.graphpaper)});
        });
        $("#expressions").click(function(){
          window.rebuild({expressions:!(window.currentCalcConstructors.expressions)});
        });
        $("#settingsMenu").click(function(){
          window.rebuild({settingsMenu:!(window.currentCalcConstructors.settingsMenu)});
        });
        $("#zoomButtons").click(function(){
          window.rebuild({zoomButtons:!(window.currentCalcConstructors.zoomButtons)});
        });
        $("#expressionsTopbar").click(function(){
          window.rebuild({expressionsTopbar:!(window.currentCalcConstructors.expressionsTopbar)});
        });
        $("#pointsOfInterest").click(function(){
          window.rebuild({pointsOfInterest:!(window.currentCalcConstructors.pointsOfInterest)});
        });
        $("#trace").click(function(){
          window.rebuild({trace:!(window.currentCalcConstructors.trace)});
        });
        $("#border").click(function(){
          window.rebuild({border:!(window.currentCalcConstructors.border)});
        });
        $("#lockViewport").click(function(){
          window.rebuild({lockViewport:!(window.currentCalcConstructors.lockViewport)});
        });
        $("#expressionsCollapsed").click(function(){
          window.rebuild({expressionsCollapsed:!(window.currentCalcConstructors.expressionsCollapsed)});
        });
        $("#administerSecretFolders").click(function(){
          window.rebuild({administerSecretFolders:!(window.currentCalcConstructors.administerSecretFolders)});
        });
        $("#images").click(function(){
          window.rebuild({images:!(window.currentCalcConstructors.images)});
        });
        $("#folders").click(function(){
          window.rebuild({folders:!(window.currentCalcConstructors.folders)});
        });
        $("#notes").click(function(){
          window.rebuild({notes:!(window.currentCalcConstructors.notes)});
        });
        $("#qwertyKeyboard").click(function(){
          window.rebuild({qwertyKeyboard:!(window.currentCalcConstructors.qwertyKeyboard)});
        });
        $("#restrictedFunctions").click(function(){
          window.rebuild({restrictedFunctions:!(window.currentCalcConstructors.restrictedFunctions)});
        });
        $("#pasteGraphLink").click(function(){
          window.rebuild({pasteGraphLink:!(window.currentCalcConstructors.pasteGraphLink)});
        });
        $("#pasteTableData").click(function(){
          window.rebuild({pasteTableData:!(window.currentCalcConstructors.pasteTableData)});
        });
        $("#degreeMode").click(function(){
          window.rebuild({degreeMode:!(window.currentCalcConstructors.degreeMode)});
        });
        $("#constructAngle").click(function(){
          window.rebuild({'construct.angle':!(window.currentGeoConstructors['construct.angle'])});
        });
        $("#constructPerpendicular").click(function(){
          window.rebuild({'construct.perpendicular':!(window.currentGeoConstructors['construct.perpendicular'])});
        });
        $("#constructParallel").click(function(){
          window.rebuild({'construct.parallel':!(window.currentGeoConstructors['construct.parallel'])});
        });
        $("#constructMidpoint").click(function(){
          window.rebuild({'construct.midpoint':!(window.currentGeoConstructors['construct.midpoint'])});
        });
        $("#constructCompass").click(function(){
          window.rebuild({'construct.compass':!(window.currentGeoConstructors['construct.compass'])});
        });
        $("#geoBorder").click(function(){
          window.rebuild({'border':!(window.currentGeoConstructors['border'])});
        });
        $("#headerbar").click(function(){
          window.rebuild({'headerbar':!(window.currentGeoConstructors['headerbar'])});
        });
        $("#geoSettings").click(function(){
          window.rebuild({'settingsmenu':!(window.currentGeoConstructors['settingsmenu'])});
        });
        $("#geoUndo").click(function(){
          window.rebuild({'undoredo':!(window.currentGeoConstructors['undoredo'])});
        });
        $("#sidebar").click(function(){
          window.rebuild({'sidebar':!(window.currentGeoConstructors['sidebar'])});
        });
        $("#geoAutosize").click(function(){
          window.rebuild({'autosize':!(window.currentGeoConstructors['autosize'])});
        });
        $("#selection").click(function(){
          window.rebuild({'selection':!(window.currentGeoConstructors['selection'])});
        });
        $("#ruler").click(function(){
          window.currentGeoConstructors.ruler = !(window.currentGeoConstructors['ruler']);
          if (!(toolType == 'geometry')) return;
          if (window.currentGeoConstructors.ruler) window.Geo.showRuler();
          else window.Geo.hideRuler();
          updateView();
          autoSave();
        });
        $("#protractor").click(function(){
          window.currentGeoConstructors.protractor = !(window.currentGeoConstructors['protractor']);
          if (!(toolType == 'geometry')) return;
          if (window.currentGeoConstructors.protractor) window.Geo.showProtractor();
          else window.Geo.hideProtractor();
          updateView();
          autoSave();
        });
        $("#customtools").click(function(){
          window.rebuild({'customtools':!(window.currentGeoConstructors['customtools'])});
        });
        $("#defaultConstructors").click(function(){
          window.reset();
        });
        $("#clearConstructors").click(function(){
          window.only();
        });
      }
      $("#copyState").click(function(){
        var currState;
        if(toolType === 'graphing') {
          workingState.saveCurrent();
          uploadImage(undefined,undefined,printState);
        } else {
          currState = window.copyState();
          printState();
        }

        function updateImage(image_data,image) {
          image.data = image_data;
        }

        function printState() {
          var images;
          if(toolType === 'graphing' && cloudinaryUpload) {
            images = workingState.getImages();
            currState = window.calculator.getState();
            currState.expressions.list.forEach(function(expr){
              var pattern = new RegExp("(?<=upload\/)(.*\/)*(?=[^\/]*\.[a-zA-Z]+$)");
              if(expr.type === "image") {
                expr.image_url = images[expr.id].url.replace(pattern,"t_FPO/");
              }
            });
          }
          var field = $('#stateInput')[0];
          field.value = JSON.stringify(currState);
          field.focus()
          field.setSelectionRange(0,field.value.length);
          var succeed;
          try {
            succeed = document.execCommand('copy');
            alert('Calculator state copied to clipboard.');
          } catch(e) {
            succeed = false;
            alert('Failed to copy to clipboard. Select and copy manually from text field above \'Copy Current State\' button.');
          }
        }
      });

      $("#save").click(function(){
        window.save();
      });

      $("#download").click(function(){
        window.download(window.calculator.getState());//{stripDefaults: false}));
      });

      function clickSlider(event){
        // return; // TODO STUB WHATEVER
        // <button> → <td> → <tr id="sliderId">
        var sliderId = event.target.parentNode.parentNode.id;
        var sliderRow = $('#'+sliderId);
        var id;
        var name;
        var func;
        var value = sliderRow.find('.sliderVal')[0].value;
        var helper;
        var success = false;
        var slider = null;

        if (sliderId == 'newSlider') {
          id = sliderRow.find('.sliderId')[0].value;
          name = sliderRow.find('.sliderVar')[0].value;
          func = sliderRow.find('.sliderFunc')[0].value;
          sliderRow = newSlider.clone(true,true).appendTo($('#sliderList'));
          sliderRow.prop("id","slider_no"+(domIdIndex++));
          if(id !== '') sliderRow.find('.sliderId')[0].innerHTML = (id);
          if(name !== '') sliderRow.find('.sliderVar')[0].innerHTML = (name);
          if(func !== '') sliderRow.find('.sliderFunc')[0].innerHTML = (func);
          if(value !== '') sliderRow.find('.sliderVal')[0].value = +value;
          else if(value === '') {
            sliderRow.find('.sliderVal')[0].value = '';
            if (name !== '') {
              helper = calculator.HelperExpression({latex:name});
              helper.observe('numericValue.slider',(function(sliderRow){
                return function(t,h){
                  if(sliderRow) sliderRow.find('.sliderVal')[0].value = h[t];
                  else h.unobserveAll();
                };
              })(sliderRow));
            }
          }
          sliderRow.find('.addSlider').click(clickSlider);
          sliderRow.find('.deleteSlider').click(deleteSlider);
          console.log('Slider created:');

          // Only need to create the slider once. No replacing w/o deleting.
          // try {
          //   slider = new DCATslider({
          //     id:id,
          //     latex:name,
          //     funcName:func,
          //     value:value
          //   }, sliderId);
          // } catch (e) {
          //   alert(e.message);
          // }
          // if (slider === null) return;
          // currentSliders[slider.id] = slider;
        } // else currentSliders[sliderId].enforce(value);
        else {
          id = sliderRow.find('.sliderId')[0].innerText;
          name = sliderRow.find('.sliderVar')[0].innerText;
          func = sliderRow.find('.sliderFunc')[0].innerText;
          console.log('Slider activated:');
          if(func !== 'N/A') {
            if(PearsonGL.External.rootJS[func] !== undefined) {
              PearsonGL.External.rootJS[func]({desmos:calculator,id:id,name:name,value:value});
            } else {
              console.log('No such function: '+func);
            }
          } else if(id !== 'N/A' && name !== 'N/A' && value !== '') {
            calculator.setExpression({id:id,latex:name+'='+value});
          }
        }
        console.log(
          'id: '+(id === '' ? 'N/A' : id)+
          '; name: '+(name === '' ? 'N/A' : name)+
          '; func: '+(func === '' ? 'N/A' : func)+
          '; value: '+(value === '' ? 'N/A' : value)
        );
      }
      // TODO STUB WHATEVER //
      $(".addSlider").click(clickSlider);

      function deleteSlider(event){
        // return; // TODO STUB WHATEVER
        // <button> → <td> → <tr id="sliderId">
        var sliderId = event.target.parentNode.parentNode.id;
        var sliderRow = $('#'+sliderId);
        if (sliderId == 'newSlider') {
          // only clear fields when deleting the "new slider" row
          sliderRow.find('.sliderId')[0].value = '';
          sliderRow.find('.sliderVar')[0].value = '';
          sliderRow.find('.sliderFunc')[0].value = '';
          sliderRow.find('.sliderVal')[0].value = '';
          sliderRow.find('.addSlider').prop("disabled",true);
        } // else currentSliders[sliderId].destroy();
        else {
          sliderRow.remove();
        }
      }

      $(".deleteSlider").click(deleteSlider);

      $('.sliderId').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addSlider').prop("disabled",false);
      });

      $('.sliderVar').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addSlider').prop("disabled",false);
      });

      $('.sliderFunc').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addSlider').prop("disabled",false);
      });

      $('.sliderVal').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addSlider').prop("disabled",false);
      });

      // Back up slider expression rows
      newSlider = $('<tr id="newSlider"><td style="text-align:center;"><span class="sliderId">N/A</span></td><td style="text-align:center;"><span class="sliderVar">N/A</span></td><td style="text-align:center;"><span class="sliderFunc">N/A</span></td><td><input type="text" class="sliderVal" placeholder="Value…"></td><td><button type="button" class="addSlider">Update</button></td><td><button type="button" class="deleteSlider">Delete</button></td></tr>');
      // END TODO STUB WHATEVER //

      $(".addHelper").click(function(event){
        // <button> → <td> → <tr id="helperId">
        var helperId = event.target.parentNode.parentNode.id;
        var helperRow = $('#'+helperId);
        var name = helperRow.find('.helperName')[0].value;
        var func = helperRow.find('.helperFunction')[0].value;
        var value = helperRow.find('.helperValue')[0].value;
        var success = false;
        var helper = null;

        if (helperId == 'newHelper') {
          helperRow.remove();
          newHelper.clone(true,true).appendTo($('#helperList'));
        } else currentHelpers[helperId].destroy();

        try {
          helper = new DCAThelper({
            latex:name,
            funcName:func,
            value:value
          }, helperId);
        } catch (e) {
          alert(e.message);
        }
        if (helper === null) return;
        currentHelpers[helper.id] = helper;
      });

      $(".deleteHelper").click(function(event){
        // <button> → <td> → <tr id="helperId">
        var helperId = event.target.parentNode.parentNode.id;
        var helperRow = $('#'+helperId);
        if (helperId == 'newHelper') {
          // only clear fields when deleting the "new helper" row
          helperRow.find('.helperName')[0].value = '';
          helperRow.find('.helperFunction')[0].value = '';
          helperRow.find('.helperValue')[0].value = '';
          helperRow.find('.addHelper').prop("disabled",true);
        } else currentHelpers[helperId].destroy();
      });

      $('.helperName').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addHelper').prop("disabled",false);
      })

      $('.helperFunction').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addHelper').prop("disabled",false);
      })

      $('.helperValue').change(function(event){
        $('#'+event.target.parentNode.parentNode.id).find('.addHelper').prop("disabled",false);
      })

      // Back up helper expression rows
      newHelper = $('#newHelper').clone(true,true);

      function loadFromInput(){
        var state;
        try {
          state = $.parseJSON($("#stateInput")[0].value);
        } catch (e) {
          alert('Failed to load state. Please input a valid Calculator or Geometry Tool state as output by the tool\'s \'getState()\' command.\n\nHint: A Calculator state will contain \"expressions\" and a Geometry Tool state will contain \"objects\".');
          return;
        }
        try {
          window.load(state);
        } catch (e) {
          alert('Failed to load state. Please input a valid Calculator or Geometry Tool state as output by the tool\'s \'getState()\' command.\n\nHint: A Calculator state will contain \"expressions\" and a Geometry Tool state will contain \"objects\".');
          return;
        }
      };
      $("#load").click(loadFromInput);

      $("#stateInput").keyup(function(e){
        if (e.keyCode == 13) loadFromInput();
      });

      $("#saveConstructors").click(function(){
        var currentConstructors = ((toolType == 'geometry') ? currentGeoConstructors : currentCalcConstructors);
        var conString = '';
        for (option in currentConstructors) {
          if (currentConstructors[option] === true && option != "administerSecretFolders") {
            if (conString.length > 0) conString += ', ';
            conString += option;
          }
        }
        var field = $('#constructorInput')[0];
        field.value = conString;
        field.focus()
        field.setSelectionRange(0,field.value.length);
        var succeed;
        try {
          succeed = document.execCommand('copy');
          alert('Constructor list copied to clipboard.');
        } catch(e) {
          succeed = false;
          alert('Failed to copy constructor list to clipboard. Select and copy manually from text field below \'Export\' button.');
        }
      });
      $("#onlyConstructors").click(function(){
        var input = $("#constructorInput")[0].value;
        var expr = 'only('+input+')';
        try {
          eval(expr);
          $("#constructorInput")[0].value = '';
        } catch (e) {
          alert('Inappropriate constructor list: \n\n  '+input+'\n\nPlease input a list of constructors as named at desmos.com/api'+((toolType=='geometry') ? '/geometry#document-geometry' : '#document-calculator')+', or a JSON object containing constructor values.');
          $("#constructorInput")[0].value = input;
        }
      });
      $("#changeConstructors").click(function(){
        var input = $("#constructorInput")[0].value;
        var expr = 'rebuild('+input+')';
        try {
          eval(expr);
          $("#constructorInput")[0].value = '';
        } catch (e) {
          alert('Inappropriate constructor list: \n\n  '+input+'\n\nPlease input a list of constructors as named at desmos.com/api'+((toolType=='geometry') ? '/geometry#document-geometry' : '#document-calculator')+', or a JSON object containing constructor values.');
          $("#constructorInput")[0].value = input;
        }
      });
      $("#desWidth").change(function(){
        if (!(typeof eval($('#desWidth')[0].value) === "number") || eval($('#desWidth')[0].value) <= 0) {
         $('#desWidth')[0].value = desWidth;
         alert('Please enter a positive integer value for Width.');
        }
        desWidth = +$('#desWidth')[0].value;
        var wAdj = desWidth;
        var hAdj = +$('#desHeight')[0].value;

        if(toolType === 'geometry' && currentGeoConstructors && !currentGeoConstructors.sidebar) {
          if(wAdj > 550 - 280) {
            wAdj += 280;
          } else {
            hAdj += 58;
          }
        }

        console.log('Changing width:',JSON.stringify({
          desWidth:desWidth,
          desHeight:desHeight,
          wAdj:wAdj,
          hAdj:hAdj
        },' ',2));

        $elt.width(wAdj);
        $frame.width(wAdj);
        $elt.height(hAdj);
        $frame.height(hAdj);
        $('#saveBrowserDiv').width(wAdj);
        window.calculator.resize();
        autoSave();
      });
      $("#desHeight").change(function(){
        if (!(typeof eval($('#desHeight')[0].value) === "number") || eval($('#desHeight')[0].value) <= 0) {
         $('#desHeight')[0].value = desHeight;
         alert('Please enter a positive integer value for Height.');
        }
        desHeight = +$('#desHeight')[0].value;
        var hAdj = desHeight;
        var wAdj = +$('#desWidth')[0].value;

        if(toolType === 'geometry' && currentGeoConstructors && !currentGeoConstructors.sidebar) {
          if(wAdj > 550 - 280) {
            wAdj += 280;
          } else {
            hAdj += 58;
          }
        }

        console.log('Changing height:',JSON.stringify({
          desWidth:desWidth,
          desHeight:desHeight,
          wAdj:wAdj,
          hAdj:hAdj
        },' ',2));

        $elt.width(wAdj);
        $frame.width(wAdj);
        $elt.height(hAdj);
        $frame.height(hAdj);
        $('#saveBrowserDiv').width(wAdj);
        window.calculator.resize();
        autoSave();
      });
      $("#w280").click(function(){
        $('#desWidth')[0].value=280;
        $('#desWidth').trigger('change');
      });
      $("#w415").click(function(){
        $('#desWidth')[0].value=415;
        $('#desWidth').trigger('change');
      });
      $("#w550").click(function(){
        $('#desWidth')[0].value=550;
        $('#desWidth').trigger('change');
      });
      $("#w860").click(function(){
        $('#desWidth')[0].value=860;
        $('#desWidth').trigger('change');
      });
      $("#h350").click(function(){
        $('#desHeight')[0].value=350;
        $('#desHeight').trigger('change');
      });
      $("#h400").click(function(){
        $('#desHeight')[0].value=400;
        $('#desHeight').trigger('change');
      });
      $("#h475").click(function(){
        $('#desHeight')[0].value=475;
        $('#desHeight').trigger('change');
      });
      var $frame = $('#frame');
      var $elt = $('#calculator');
      window.agaColors = {
        blue: '#0092C8',
        red: '#F15A22',
        green: '#0AB14B',
        purple: '#812990',
        black: '#000000',
        // grey: '#58595B',
        // teal: '#36C1CD',
        orange: '#EFA038'//,
        // lime: '#95CA59'
      };
      window.mgmColors = {
        blue: '#0092C8',
        red: '#F15A22',
        green: '#0DB14B',
        purple: '#812990',
        black: '#000000',
        //purpleFill: '#941B81',
        //blueFill: '#229FEE',
        orangeFill: '#F68B1F'//,
        //greenFill: '#62BA46',
        //grey: '#58595B'
      };
      window.colors = window.agaColors;
      window.geoColors = {
        colors: [
          '#0092C8', // blue
          '#F15A22', // red
          '#0AB14B', // green
          '#812990', // purple
          '#EFA038', // orange
          '#000000', // black
          '#58595B' // grey
        ],
        defaults: {
          point: window.agaColors.black,
          line: window.agaColors.black,
          circle: window.agaColors.black,
          angle: window.agaColors.red,
          polygon: window.agaColors.blue
        }
      };
      var defaultGraphSettings = {
        degreeMode:true,
        xAxisArrowMode:Desmos.AxisArrowModes.BOTH,
        yAxisArrowMode:Desmos.AxisArrowModes.BOTH,
        xAxisLabel:"x",
        yAxisLabel:"y"
      };
      constructorShortcuts: {
        window.keypad={'keypad':true};
        window.graphpaper={'graphpaper':true};
        window.expressions={'expressions':true};
        window.settingsMenu={'settingsMenu':true};
        window.zoomButtons={'zoomButtons':true};
        window.expressionsTopbar={'expressionsTopbar':true};
        window.pointsOfInterest={'pointsOfInterest':true};
        window.trace={'trace':true};
        window.border={'border':true};
        window.lockViewport={'lockViewport':true};
        window.expressionsCollapsed={'expressionsCollapsed':true};
        window.images={'images':true};
        window.folders={'folders':true};
        window.notes={'notes':true};
        window.qwertyKeyboard={'qwertyKeyboard':true};
        window.restrictedFunctions={'restrictedFunctions':true};
        window.pasteGraphLink={'pasteGraphLink':true};
        window.pasteTableData={'pasteTableData':true};
        window.degreeMode={'degreeMode':true};
        window.colors={'colors':agaColors};
        window.construct={
          angle:{'construct.angle':true},
          perpendicular:{'construct.perpendicular':true},
          parallel:{'construct.parallel':true},
          midpoint:{'construct.midpoint':true},
          compass:{'construct.compass':true}
        };
        window.border={'border':true};
        window.headerbar={'headerbar':true};
        window.settingsmenu={'settingsmenu':true};
        window.undoredo={'undoredo':true};
        window.sidebar={'sidebar':true};
        window.autosize={'autosize':true};
        window.selection={'selection':true};
        window.ruler={'ruler':true};
        window.protractor={'protractor':true};
        window.customtools={'customtools':true};
        window.calcConstructors = {
          /*Comment indicates difference from default.*/
          /* default: graphpaper, expressions, settingsMenu, zoomButtons, expressionsTopbar, pointsOfInterest, trace, border, expressionsCollapsed, folders, notes, qwertyKeyboard, pasteTableData, degreeMode */
          default:{
            'keypad':false,
            'graphpaper':true,
            'expressions':true,
            'settingsMenu':true,
            'zoomButtons':true,
            'expressionsTopbar':true,
            'pointsOfInterest':true,
            'trace':true,
            'border':true,
            'lockViewport':false,
            'expressionsCollapsed':true,
            'images':false,
            'folders':true,
            'notes':true,
            'qwertyKeyboard':true,
            'restrictedFunctions':false,
            'pasteGraphLink':false,
            'pasteTableData':true,
            'degreeMode':true,
            'colors':agaColors
          },
          /* allOff: */
          allOff:{
            'keypad':false,
            'graphpaper':false, /**/
            'expressions':false, /**/
            'settingsMenu':false, /**/
            'zoomButtons':false, /**/
            'expressionsTopbar':false, /**/
            'pointsOfInterest':false, /**/
            'trace':false, /**/
            'border':false, /**/
            'lockViewport':false,
            'expressionsCollapsed':false, /**/
            'images':false,
            'folders':false, /**/
            'notes':false, /**/
            'qwertyKeyboard':false, /**/
            'restrictedFunctions':false,
            'pasteGraphLink':false,
            'pasteTableData':false, /**/
            'degreeMode':false, /**/
            'colors':agaColors
          }
        }
        window.geoConstructors = {
          /* default: perpendicular, parallel, midpoint, compass, border, selection, sidebar */
          default:{
            'construct.angle':true,
            'construct.perpendicular':true,
            'construct.parallel':true,
            'construct.midpoint':true,
            'construct.compass':true,
            'border':true,
            'headerbar':true,
            'settingsmenu':true,
            'undoredo':true,
            'sidebar':true,
            'autosize':true,
            'selection':true,
            'ruler':false,
            'protractor':false,
            'colorMap':geoColors,
            'customtools':false
          },
          /* allOff */
          allOff:{
            'construct.angle':true,
            'construct.perpendicular':false,
            'construct.parallel':false,
            'construct.midpoint':false,
            'construct.compass':false,
            'border':false,
            'headerbar':false,
            'settingsmenu':false,
            'undoredo':false,
            'sidebar':false,
            'autosize':false,
            'selection':false,
            'ruler':false,
            'protractor':false,
            'colorMap':geoColors,
            'customtools':false
          }
        }
      }
      window.currentCalcConstructors = mergeObjects({},window.calcConstructors.default,{administerSecretFolders:true});
      window.currentGeoConstructors = mergeObjects({},window.geoConstructors.default);
      window.calculator = window.Calc = window.Geo = null;

      var toolType = 'graphing';
      var calcDefaultState = null;
      var geoDefaultState = null;
      var geoConstructorsSansTools = null;
      var calcPrevState = null;
      var geoPrevState = null;
      var desWidth = 550;
      var desHeight = 475;
      var workingState = null;
      var autoSaveQueued = false;
      window.queuedSave = null;

      var buttonMap = {
        graphing: {
          'keypad':'keypad',
          'graphpaper':'graphpaper',
          'expressions':'expressions',
          'settingsMenu':'settingsMenu',
          'zoomButtons':'zoomButtons',
          'expressionsTopbar':'expressionsTopbar',
          'pointsOfInterest':'pointsOfInterest',
          'trace':'trace',
          'border':'border',
          'lockViewport':'lockViewport',
          'expressionsCollapsed':'expressionsCollapsed',
          'administerSecretFolders':'administerSecretFolders',
          'images':'images',
          'folders':'folders',
          'notes':'notes',
          'qwertyKeyboard':'qwertyKeyboard',
          'restrictedFunctions':'restrictedFunctions',
          'pasteGraphLink':'pasteGraphLink',
          'pasteTableData':'pasteTableData',
          'degreeMode':'degreeMode',
          'colors':agaColors
        },
        geometry: {
          'construct.angle':'constructAngle',
          'construct.perpendicular':'constructPerpendicular',
          'construct.parallel':'constructParallel',
          'construct.midpoint':'constructMidpoint',
          'construct.compass':'constructCompass',
          'border':'geoBorder',
          'headerbar':'headerbar',
          'settingsmenu':'geoSettings',
          'undoredo':'geoUndo',
          'sidebar':'sidebar',
          'autosize':'geoAutosize',
          'selection':'selection',
          'ruler':'ruler',
          'protractor':'protractor',
          'colorMap':geoColors,
          'customtools':'customtools'
        }
      };

      var savedGraphs = [];
      var currentHelpers = {};

      function savedGraph(pack,ID) {
        if(pack === undefined) pack = null;
        if(ID === undefined) ID = null;
        var self = this;
        var id = DOM_ID_PREFIX+(ID?ID:(domIdIndex++));
        var position = ((ID == 'workingState')?-1:savedGraphs.length);
        var name = ((ID == 'workingState') ? "AutoSaved" : '');
        var type;
        var constructors;
        var state;
        var helpers = [];
        var width;
        var height;
        var $gui;
        var thumbnail;
        var images = {};

        this.getImages = function() {return images;};

        this.saveCurrent = function(updateLibrary) {
          if(updateLibrary === undefined) updateLibrary = true;
          type = toolType;
          state = window.calculator.getState();//{stripDefaults: false});
          width = desWidth;
          height = desHeight;
          helpers = [];
          var newImages = {};

          if (toolType == 'graphing') {
            // SAVE DCAT HELPERS
            objKeys(currentHelpers).forEach(function(helper) {
              helpers.push(currentHelpers[helper].package());
            });

            // FPO TODO TK ETC SAVE DCAT SLIDERS

            // SAVE IMAGE DATA
            if(cloudinaryUpload) state.expressions.list.forEach(function(expr,index){
              var img_data;
              var image;
              var update = false;
              if(expr.type === "image") {
                newImages[expr.id] = true;
                img_data = expr.image_url;
                image = images[expr.id];

                // Image needs to be updated if:
                //  * It is not stored yet
                //  * It does not have a cloud backup
                //  * Its backup is out of date
                if(image === undefined) {
                  image = {
                    id:expr.id,
                    name:expr.name,
                    originalFilename:expr.originalFilename
                  };
                  update = true;
                } else if(image.url === undefined) {
                  console.log("Image with id:\""+expr.id+"\" was missing cloud backup. Updating now.");
                  delete image.data;
                  update = true;
                } else if (image.url !== img_data) {
                  console.log("Image with id:\""+expr.id+"\" changed URL from \""+shortenImageData(image.url)+"\" to \""+shortenImageData(img_data)+"");
                  delete image.url;
                  delete image.data;
                  update = true;
                }

                if(update === true) {
                  if(img_data.startsWith("http")) {
                    image.url = img_data;
                  } else if(img_data.startsWith("data:image")) {
                    console.log("Uploading "+expr.name+" to cloudinary…");
                    image.data = img_data;
                    try {
                      uploadImage(img_data,function(e,data){
                        var expr = state.expressions.list[index];
                        var new_url = data.result.secure_url;
                        if(expr.image_url === img_data) {
                          console.log("Updating state "+id+" with cloud backup for image id \""+image.id+"\" ("+image.name+") at "+new_url);
                          image.url = new_url;
                          expr.image_url = new_url;
                          console.log(state);
                        } else {
                          throw new Error("Uploaded image with id \""+image.id+"\" ("+image.name+") no longer matches graph state. Aborting update of image at "+image.url);
                        }
                      },((name === "AutoSaved") ? load : updateStorage));
                    } catch (e) {
                      console.log("Attempt to upload image with id \""+image.id+"\" ("+image.name+") failed with the following message:")
                      console.log(e.message);
                    }
                  } else throw new Error("Expression \""+expr.id+"\" is image of unknown type. Aborting save.");
                  images[expr.id] = image;
                }
              }
            });

            // Make sure any old images are still represented. If not, delete their data.
            objKeys(images).forEach(function(id){
              if(newImages[id] !== true) {
                console.log("Deleting image with id:\""+id+"\".");
                delete images[id];
              }
            });

            if(objKeys(images).length > 0) {
              getImageData(images,function(data,image){
                image.data = data;
              },function(){
                console.log("Current state has the following images:",images);
              });
            }
          }

          if (toolType == 'graphing') {
            constructors = mergeObjects({},window.currentCalcConstructors);
          } else if (toolType == 'geometry') {
            constructors = mergeObjects({},window.currentGeoConstructors);
          };

          if ($gui === undefined) buildGui();

          thumbnail = window.calculator.screenshot({width:2*previewWidth,height:2*previewHeight});

          $('#'+id+'_img').attr("src",thumbnail);

          // NEW CLOUDINARY STUFF
          if (cloudinaryUpload && position !== -1) {

            $gui.css("background","silver");

            cloudinaryUpload.one('fileuploaddone',function(e,data){
              thumbnail = data.result.secure_url;
              $('#'+id+'_img').attr("src",data.result.secure_url);
              $gui.css("background","white");
              if (updateLibrary) updateStorage();
            });

            cloudinaryUpload.fileupload('option','formData').file = thumbnail;
            cloudinaryUpload.fileupload('add', { files: [ thumbnail ] });

          } else
          // END NEW CLOUDINARY STUFF

            if (updateLibrary) updateStorage();
        }

        if (pack && (pack['state'])) {
          unpack(pack);
          if (ID == 'workingState') {
            if (type == "graphing") {
              if (calcPrevState == null) {
                calcPrevState = calcDefaultState = state;
              }
            } else if (type == "geometry") {
              if (geoPrevState == null) {
                geoPrevState = geoDefaultState = state;
              }
            }
            load();
          }
        } else if (window.calculator) self.saveCurrent(false);

        function buildGui() {
          if ($gui === undefined) {
            var $cell = $('<td id="'+id+'_cell" style="text-align:center;border-style:solid;border-width:1px;vertical-align:top;"><div id="'+id+'"></div></td>');
            if (id == DOM_ID_PREFIX+'workingState') $('#saveBrowserRow').append($cell);
            else $cell.insertAfter($('#'+DOM_ID_PREFIX+'workingState_cell'));
            $gui = $('#'+id);
          } else {
            $gui.remove();
            $gui.appendTo($('#'+id+'_cell'));
            $gui.html('');
          }
          if (id != DOM_ID_PREFIX+'workingState') {
            $gui.append('<input type="text" id="'+id+'_name" placeholder="unnamed widget" style="text-align:center;width:'+previewWidth+'px;"><br>'+
            '<div style="width:'+previewWidth+'px;height:'+previewHeight+'px;border-style:outset;border-width:2px;">'+
            '<img class="'+id+'_load" id="'+id+'_img" style="max-width:100%;max-height:100%;">'+
            '</div><div style="float:bottom;">'+
            '<button type="button" class="'+id+'_load">load</button><br>'+
            '<button type="button" class="'+id+'_download">download</button><br>'+
            '<button type="button" class="'+id+'_save">overwrite</button><br>'+
            '<button type="button" class="'+id+'_delete">delete</button></div>');
            if (name !== undefined) $('#'+id+'_name')[0].value=name;
            $('#'+id+'_name').change(function(){name=$('#'+id+'_name')[0].value;updateStorage()});
            $('.'+id+'_load').click(function(){check('load');});
            $('.'+id+'_save').click(function(){check('save');});
            $('.'+id+'_delete').click(function(){check('delete');});
          } else {
            $gui.append('<div id="'+id+'_name" style="float:top;padding:2px">AutoSaved</div><div style="float:top;width:'+previewWidth+'px;height:'+previewHeight+'px;border-style:outset;border-width:2px;">'+
            '<img id="'+id+'_img" style="max-width:100%;max-height:100%;">'+
            '</div><br><div style="float:bottom;">'+
            '<button type="button" class="'+id+'_download">download</button><br>'+
            '<button type="button" class="'+id+'_new">save as new</button><br>'+
            '<button type="button" class="'+id+'_clear">clear all</button></div>')
            $('.'+id+'_new').click(function(){check('new');});
            $('.'+id+'_clear').click(function(){check('clear');});
          }
          $('.'+id+'_download').click(download);
        }

        function download() {
          var file = {
            name:name,
            type:type,
            state:state,
            helpers:helpers
          };
          window.download(file,name);
        }

        function check(type) {
          for (graph in savedGraphs) savedGraphs[graph].clearWarning();
          $gui.detach();
          $('#'+id+'_cell').append($checkWarnGui);
          switch (type) {
            case 'load':
              $('#checkWarn').html('Load '+(name?name:'unnamed widget')+' without saving current state?');
              $('#checkConfirm').html('cancel');
              $('#checkConfirm').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'));
              });
              $('#checkCancel').html('load without saving');
              $('#checkCancel').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'))
                load()
              });
              break;
            case 'save':
              $('#checkWarn').html('Overwrite '+(name?name:'unnamed widget')+' with current state?');
              $('#checkConfirm').html('overwrite');
              $('#checkConfirm').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'));
                self.saveCurrent();
              });
              $('#checkCancel').html('cancel');
              $('#checkCancel').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'));
              });
              break;
            case 'delete':
              $('#checkWarn').html('Are you sure you want to delete '+(name?name:'unnamed widget')+'?');
              $('#checkConfirm').html('delete '+(name?name:'unnamed widget'));
              $('#checkConfirm').click(function(){
                $checkWarnGui.remove();
                destroy();
              });
              $('#checkCancel').html('keep '+(name?name:'unnamed widget'));
              $('#checkCancel').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'))
              });
              break;
            case 'new':
              $('#checkWarn').html('Create new save from current state?');
              $('#checkConfirm').html('save new');
              $('#checkConfirm').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'));
                window.save();
              });
              $('#checkCancel').html('cancel');
              $('#checkCancel').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'));
              });
              break;
            case 'clear':
              $('#checkWarn').html('Clear current graph and reset to default settings?');
              $('#checkConfirm').html('clear all');
              $('#checkConfirm').click(function(){
                $checkWarnGui.remove();
                calcDefaultState = null;
                geoDefaultState = null;
                calcPrevState = null;
                geoPrevState = null;
                desWidth = 550;
                desHeight = 475;
                $elt.remove();
                delete window.Calc;
                delete window.Geo;
                $gui.appendTo($('#'+id+'_cell'));
                window.reset();
              });
              $('#checkCancel').html('cancel');
              $('#checkCancel').click(function(){
                $checkWarnGui.remove();
                $gui.appendTo($('#'+id+'_cell'))
              });
              break;
          }
        }

        this.clearWarning = function() {
          if ($checkWarnGui.parent().is($('#'+id+'_cell'))) {
            $checkWarnGui.remove();
            $('#'+id+'_cell').append($gui);
          }
        }

        function load() {
          desWidth = +width;
          desHeight = +height;
          if (type == 'graphing') {
            window.currentCalcConstructors = mergeObjects({},constructors,{colors:window.agaColors});
          } else if (type == 'geometry') {
            window.currentGeoConstructors = mergeObjects({},constructors,{colorMap:window.geoColors});
          };
          window.load(state,{allowUndo:false,remapColors:false});
          var newHelper;
          for (helper in helpers) {
            newHelper = null;
            try {
              newHelper = new DCAThelper(helpers[helper]);
            } catch (e) {
              alert(e.message);
            }
            if(newHelper !== null) {
              currentHelpers[newHelper.id] = newHelper;
            } else {
              delete helpers[helper];
            }
          }
        }

        this.package = function() {
          var imageURLs = [];
          // console.log("Packing state with the following images:",images);
          objKeys(images).forEach(function(e){
            // console.log("Image "+e+":",images[e]);
            if(typeof images[e].url === "string" && images[e].url.startsWith("http")) {
              imageURLs.push({id:images[e].id,url:images[e].url});
            }
          });

          var pack = {
            name:name,
            type:type,
            constructors:constructors,
            state:state,
            helpers:helpers,
            width:width,
            height:height,
            preview:thumbnail,
            previewCloud:(($('#'+id+'_img').attr("src")===thumbnail)?undefined:$('#'+id+'_img').attr("src")),
            images:imageURLs
          };

          return pack;
        }

        function unpack(pack) {
          name = pack.name;
          type = pack.type;
          constructors = mergeObjects({},pack.constructors);
          state = pack.state;
          width = pack.width;
          height = pack.height;
          helpers = mergeObjects([],pack.helpers);
          thumbnail = pack.previewCloud ? pack.previewCloud : pack.preview;
          images = {};
          if(Array.isArray(pack.images)) pack.images.forEach(function(e){
            images[e.id] = {id:e.id,url:e.url};
          });
          buildGui();

          $('#'+id+'_img').attr("src",thumbnail);
        }

        function destroy() {
          $('#'+id+'_cell').remove();
          for (i=position+1;i<savedGraphs.length;i++) {
            savedGraphs[i].shiftLeft();
          }
          savedGraphs.splice(position,1);

          updateStorage();

          delete self;
        }

        this.shiftLeft = function() {
          position--;
        }
      }

      function DCAThelper(pack,id) {
        if(id === undefined) id = null;
        var self = this;
        this.id = (((id == 'newHelper')||(id === null)) ? (DOM_ID_PREFIX+(domIdIndex++)) : id);
        var latex;
        var value;
        var funcName;
        var helper = null;
        var func;
        var $row;

        unpack(pack);

        if (PearsonGL.External.masterJS[funcName] === undefined) {
          if (PearsonGL.External.rootJS[funcName] === undefined) {
            $row.remove();
            throw new Error('Function does not exist: '+funcName);
            return null;
          } else {
            func = (function() {
              if (value == '') return function() {
                return PearsonGL.External.rootJS[funcName]({
                  value:helper.numericValue,
                  name:latex,
                  desmos:window.calculator,
                  log:console.log
                });
              };
              else return function() {
                if (helper.numericValue == value) return PearsonGL.External.rootJS[funcName]({
                  value:helper.numericValue,
                  name:latex,
                  desmos:window.calculator,
                  log:console.log
                });
              };
            })();
          }
        } else {
          func = (function() {
            if (value == '') return function() {
              return PearsonGL.External.masterJS[funcName](helper.numericValue,latex,window.calculator);
            };
            else return function() {
              if (helper.numericValue == value) return PearsonGL.External.masterJS[funcName](helper.numericValue,latex,window.calculator);
            };
          })();
        }

        this.enable = function() {
          if (helper !== null) {
            throw new Error('Helper function \"'+latex+'\": \"'+funcName+'\" already initialized.');
            if (helper.__observers.numericValue === undefined) {
              throw new Error('Helper function \"'+latex+'\": \"'+funcName+'\" was initialized but was not observed. Attempting to add observer.');
            } else return true;
          } else if (window.calculator.HelperExpression === undefined) {
            $row.remove();
            throw new Error('Helper function \"'+latex+'\": \"'+funcName+'\" not supported by current tool type: '+window.tooltype);
            return false;
          } else {
            helper = window.calculator.HelperExpression({latex:latex});
          }

          helper.observe('numericValue', func);

          if($row) {
            $row.appendTo($('#helperList'));
            $('#newHelper').appendTo($('#helperList'));
          }

          return true;
        };

        if (!(self.enable())) {
          $row.remove();
          delete self;
          return null;
        }

        this.disable = function() {
          if (helper === null) {
            throw new Error('Error disabling helper function: \"'+latex+'\": \"'+funcName+'\" was not initialized.');
            return true;
          }

          $row.detach();

          helper.unobserveAll();
          helper = null;
          return true;
        }

        this.destroy = function() {
          self.disable();
          delete currentHelpers[self.id];

          if (!(autoSaveQueued)) autoSave();

          $row.remove();

          delete self;
        }

        this.package = function() {
          return {
            latex:latex,
            funcName:funcName,
            value:value
          };
        }

        function unpack(pack) {
          latex = pack.latex;
          funcName = pack.funcName;
          value = pack.value;
          buildGui();
        }

        function buildGui() {
          if ($row === undefined) {
            if($('#'+self.id).length > 0) $row = $('#'+self.id);
            else {
              $row = newHelper.clone(true,true).attr('id',self.id).appendTo($('#helperList'));
              $('#newHelper').appendTo($('#helperList'));
            }
          }
          $row.find('.helperName')[0].value = latex;
          $row.find('.helperFunction')[0].value = funcName;
          $row.find('.helperValue')[0].value = value;
          $row.find('.addHelper').html('Update');
          $row.find('.addHelper').prop("disabled",true);
          $row.find('.deleteHelper').html('Delete');
        }
      }

      function updateStorage() {
        if (typeof(Storage) !== undefined) {
          var package = [];
          for (graph in savedGraphs) package.push(savedGraphs[graph].package());
          localStorage.setItem("AGAsavedGraphs",JSON.stringify(package));
        } else {
          console.log('No local storage available.');
        }
      }

      function autoSave() {
        if (window.queuedSave) {
          window.clearTimeout(window.queuedSave);
          delete window.queuedSave;
        }
        if (workingState === null) {
          autoSaveQueued = false;
          console.log('Autosave unavailable.');
          return;
        }
        autoSaveQueued = true;
        console.log('Autosaving…');
        workingState.saveCurrent(false);
        latestVersion = Date.now();
        autoSaveQueued = false;
        if (typeof(Storage) === undefined) return;
        // console.log('Checking for new versions…')
        // if (latestVersion < localStorage.AGAcurrentVersion); // STUB
        localStorage.setItem("AGAautoSave",JSON.stringify(workingState.package()));
        localStorage.setItem("AGAcurrentVersion",Date.now());
      }

      // Note: never set toolType before refreshing the calculator;
      //       toolType should always match current toolType.
      function refreshCalculator(type){
        if(type === undefined) type = toolType;
        if (window.queuedSave) {
          window.clearTimeout(window.queuedSave);
          delete window.queuedSave;
          autoSaveQueued = false;
        }

        // Clean up previous instances
        if (toolType == 'graphing') for (helper in currentHelpers) currentHelpers[helper].disable();

        window.calculator = null;
        if(window.Geo) {
          geoPrevState = window.Geo.getState();//{stripDefaults: false});
          delete window.Geo;
        }
        if(window.Calc) {
          calcPrevState = window.Calc.getState();//{stripDefaults: false});
          delete window.Calc;
        }
        if($elt) $elt.remove();

        // Build the frame and UI
        var wAdj = desWidth;
        var hAdj = desHeight;

        if(type === 'geometry' && currentGeoConstructors && !currentGeoConstructors.sidebar) {
          $('#warning').html('<div id="warning"><span style="">sidebar not included in dimensions. (sidebar off)</span></div>');
          if(wAdj > 550 - 280) {
            wAdj += 280;
          } else {
            hAdj += 58;
          }
        } else {
          $('#warning').html('<div id="warning"></div>');
        }

        $frame.html('<div id="calculator" style="width:'+wAdj+'px;height:'+hAdj+'px;"></div>');
        $frame.width(wAdj);
        $frame.height(hAdj);
        $elt = $('#calculator');

        $('#desWidth')[0].value=desWidth;
        $('#desHeight')[0].value=desHeight;
        $('#saveBrowserDiv').width(wAdj);

        // Instantiate the calculator and set its state
        if (type == 'graphing') {
          window.calculator = window.Calc = Desmos.GraphingCalculator($elt[0], window.currentCalcConstructors);
          if (calcPrevState) window.calculator.setState(calcPrevState);
          else window.calculator.updateSettings(defaultGraphSettings);
          if (calcDefaultState) window.calculator.setDefaultState(calcDefaultState);
          else window.calculator.setDefaultState(window.calculator.getState());//{stripDefaults: false}));
        } else if (type == 'geometry') {
          if(!currentGeoConstructors.sidebar) {
            $('#warning').html('<div id="warning"><span style=""> sidebar not included in dimensions. (sidebar off)</span></div>');
          }
          geoConstructorsSansTools = mergeObjects({},currentGeoConstructors,{sidebar:true});
          delete geoConstructorsSansTools.protractor;
          delete geoConstructorsSansTools.ruler;
          window.calculator = window.Geo = Desmos.Geometry($elt[0], geoConstructorsSansTools);
          if (geoPrevState) window.calculator.setState(geoPrevState);
          if (window.currentGeoConstructors.ruler) window.Geo.showRuler();
          if (window.currentGeoConstructors.protractor) window.Geo.showProtractor();
          if (geoDefaultState) window.calculator.setDefaultState(geoDefaultState);
        };

        // Register autosave
        window.calculator.observeEvent('change',function(){
          if (!autoSaveQueued) {
            autoSaveQueued = true;
            console.log('Queueing autosave…');
            window.queuedSave = window.setTimeout(autoSave,window.AUTO_SAVE_INTERVAL);
          }
        });

        if (type == 'graphing') for (helper in currentHelpers) currentHelpers[helper].enable();

        toolType = type;
        updateView();

        $elt.resizable({
          handles: 'e, s, se',
          grid: [5,5],
          resize: function(evt, ui) {
            var tail='';
            var h=ui.size.height;
            var w=ui.size.width;
            var wAdj = w;
            var hAdj = h;
            if(toolType === 'geometry' && currentGeoConstructors && !currentGeoConstructors.sidebar) {
              if(w > 550) {
                wAdj = w - 280;
              } else {
                hAdj = h - 58;
              }
            }
            if (Math.abs(280-wAdj)<15) {wAdj=280; tail+=' (1/3 Column)';}
            else if (Math.abs(415-wAdj)<15) {wAdj=415; tail+=' (50% Column)';}
            else if (Math.abs(550-wAdj)<15) {wAdj=550; tail+=' (2/3 Column)';}
            else if (Math.abs(860-wAdj)<15) {wAdj=860; tail+=' (Full Column)';}
            if (Math.abs(475-hAdj)<15) {hAdj=475; tail+=' (Height 1)';}
            else if (Math.abs(400-hAdj)<15) {hAdj=400; tail+=' (Height 2)';}
            else if (Math.abs(350-hAdj)<15) {hAdj=350; tail+=' (Height 3)';}
            if(toolType === 'geometry' && currentGeoConstructors && !currentGeoConstructors.sidebar) {
              if(w > 550) {
                w = wAdj + 280;
                h = hAdj;
              } else {
                w = wAdj;
                h = hAdj + 58;
              }
            } else {
              w = wAdj;
              h = hAdj;
            }
            console.log('' + wAdj + ' × ' + hAdj + tail);
            $frame.width(w);
            $frame.height(h);
            ui.size.width = w;
            ui.size.height = h;
            $('#saveBrowserDiv').width(w);
            $('#desWidth')[0].value=wAdj;
            $('#desHeight')[0].value=hAdj;
          },
          stop: function(evt, ui) {
            window.calculator.resize();
            autoSave();
          }
        });

        if (!(autoSaveQueued)) autoSave();
      }

      function updateView(type){
        if(type === undefined) type = toolType;
        if ((type == "geometry") && (!($("#geoConstructorButtons").is(":visible")))) {
          $("#calcConstructorButtons").hide();
          $("#geoConstructorButtons").show();
          $("#graphing").css("background",offbuttoncolor);
          $("#graphing").css("color",offtextcolor);
          $("#geometry").css("background",onbuttoncolor);
          $("#geometry").css("color",ontextcolor);
        } else if ((type == "graphing") && (!($("#calcConstructorButtons").is(":visible")))) {
          $("#geoConstructorButtons").hide();
          $("#calcConstructorButtons").show();
          $("#graphing").css("background",onbuttoncolor);
          $("#graphing").css("color",ontextcolor);
          $("#geometry").css("background",offbuttoncolor);
          $("#geometry").css("color",offtextcolor);
        }
        var currentConstructors = ((type == "graphing")?currentCalcConstructors:currentGeoConstructors);
        if ((type == 'geometry') && (currentConstructors.ruler === undefined)) currentConstructors.ruler = false;
        if ((type == 'geometry') && (currentConstructors.protractor === undefined)) currentConstructors.protractor = false;
        for (option in currentConstructors) {
          if (typeof(currentConstructors[option]) !== 'boolean');
          else {
            var $option= $("#"+buttonMap[type][option]);
            if (currentConstructors[option]) {
              $option.html("ON");
              $option.css("background",onbuttoncolor);
              $option.css("color",ontextcolor);
            } else {
              $option.html("OFF");
              $option.css("background",offbuttoncolor);
              $option.css("color",offtextcolor);
            };
          };
        };

        if(toolType != type) {
          refreshCalculator(type);
        };
      }

      window.rebuild = function(options) {
        if(options === undefined) options = {};
        // Update the constructors
        var currentConstructors = ((toolType == "graphing")?currentCalcConstructors:currentGeoConstructors);
        for (arg in arguments) mergeObjects(currentConstructors,arguments[arg]);
        refreshCalculator();
      };
      window.reset = function(options) {
        if(options === undefined) options = {};
        if (toolType == 'graphing') {
          delete window.currentCalcConstructors;
          window.currentCalcConstructors = mergeObjects({},window.calcConstructors.default,{'administerSecretFolders':true});
        } else if (toolType == 'geometry') {
          delete window.currentGeoConstructors;
          window.currentGeoConstructors = mergeObjects({},window.geoConstructors.default);
        }
        window.rebuild.apply(this,arguments);
      };
      window.only = function(options) {
        if(options === undefined) options = {};
        if (toolType == 'graphing') {
          delete window.currentCalcConstructors;
          window.currentCalcConstructors = mergeObjects({},window.calcConstructors.allOff,{'administerSecretFolders':true});
        } else if (toolType == 'geometry') {
          delete window.currentGeoConstructors;
          window.currentGeoConstructors = mergeObjects({},window.geoConstructors.allOff);
        }
        window.rebuild.apply(this,arguments);
      };
      window.show = function(options) {
        if(options === undefined) options = {};
        if (toolType == 'graphing') {
          mergeObjects(window.currentCalcConstructors,{'administerSecretFolders':true});
        };
        window.rebuild.apply(this,options);
      };
      window.hide = function(options) {
        if(options === undefined) options = {};
        if (toolType == 'graphing') {
          mergeObjects(window.currentCalcConstructors,{'administerSecretFolders':false});
        };
        window.rebuild.apply(this,options);
      };
      window.load = function(state,options){
        if(options === undefined) options={remapColors:true,allowUndo:true};
        if (window.queuedSave) {
          window.clearTimeout(window.queuedSave);
          delete window.queuedSave;
        }
        autoSaveQueued = true;
        var type;
        if (state.expressions != undefined) {
          calcDefaultState = state;
          type = 'graphing';
        }
        if (state.objects != undefined) {
          geoDefaultState = state;
          type = 'geometry';
        }

        for (helper in currentHelpers) currentHelpers[helper].destroy();

        refreshCalculator(type);
        window.calculator.setState(state, options);
        autoSave();
        var screen = window.calculator.screenshot({width:previewWidth,height:previewHeight});
        var shotAsync = window.setInterval(function(){
          if(screen != window.calculator.screenshot({width:previewWidth,height:previewHeight})) {
            clearInterval(shotAsync);
            autoSave();
          }
        },LOADING_TIME_ALLOTMENT);
      };
      window.copyState = function() {
        var currState = window.calculator.getState();//{stripDefaults: false});
        try {copy(JSON.stringify(currState));} catch(e) {};
        return currState;
      };
      window.download = function(state, filename){
        if(filename === undefined) filename ="unnamed_widget";
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(state,null,"\t")));
        element.setAttribute('download', ((filename == '')?"unnamed_widget":filename)+'.json');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      };

      window.save = function() {
        savedGraphs.push(new savedGraph());
        updateStorage();
      };

      var latestVersion = Date.now();

      if (typeof(Storage) !== "undefined" && typeof localStorage !== "undefined") {
        // Transfer old storage to namespaced storage
        if (localStorage.getItem("savedGraphs")) {
          let currentVersion = localStorage.getItem("currentVersion"),
              autoSave = localStorage.getItem("autoSave"),
              savedGraphs = localStorage.getItem("savedGraphs");

          localStorage.removeItem("autoSave");
          localStorage.removeItem("savedGraphs");
          localStorage.removeItem("currentVersion");

          localStorage.setItem("AGAautoSave",autoSave);
          localStorage.setItem("AGAcurrentVersion",currentVersion);
          localStorage.setItem("AGAsavedGraphs",savedGraphs);
        }
        // End Transfer
        
        if (localStorage.getItem("AGAcurrentVersion")) latestVersion = localStorage.getItem("AGAcurrentVersion");
        if (localStorage.getItem("AGAautoSave")) {
          workingState = new savedGraph($.parseJSON(localStorage.getItem("AGAautoSave")),'workingState');
        } else {
          workingState = new savedGraph(null,'workingState');
          refreshCalculator();
        }
        if (localStorage.getItem("AGAsavedGraphs")) {
          var unpacked = $.parseJSON(localStorage.getItem("AGAsavedGraphs"));
          for (graph in unpacked) savedGraphs.push(new savedGraph(unpacked[graph]));
        }
      } else {
        console.log('Cannot load saved data. No storage available.');
      // by default, administer secret folders
      window.show();
      }
    });
  </script>
</body>
</html>