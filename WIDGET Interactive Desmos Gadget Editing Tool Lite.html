<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>WIDGET Interactive Desmos Gadget Editing Tool</title>
  <link href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css" />
  <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://www.desmos.com/api/v0.9/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
  <script src="https://www.desmos.com/api/v0.9/geometry.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
  <script src="./Desmos AGA Root SCO CJS.js"></script>
  <script src="./Desmos AGA Root SCO CJS Test Master SCO CJS.js"></script>
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
    }
    #calculator {
      width: 550px;
      height: 450px;
    });
  </style>
</head>
<body>
  <table>
    <tr>
      <td style="vertical-align:top;">
        <div id="frame"><div id="calculator"></div></div>
      </td>
      <td rowspan="2" style="vertical-align:top;text-align:center">
        <button type="button" id="graphing" style="background:green;color:white;">Calculator</button>&nbsp;<button type="button" id="geometry" style="background:red;color:white;">Geometry</button>
      </td>
    </tr>
    <tr height="100%">
      <td style="vertical-align:top">
        <button type="button" id="copyState">Copy Current State</button><br>
        <input type="text" id="stateInput" placeholder="Paste state here…">
        <button type="button" id="load">Load State</button>
      </td>
    </tr>
  </table>
  <script>
    $(function() {
      var onbuttoncolor = "green";
      var ontextcolor = "white";
      var offbuttoncolor = "red";
      var offtextcolor = "white";

      $("#graphing").click(function(){
        $("#graphing").css("background",onbuttoncolor);
        $("#graphing").css("color",ontextcolor);
        $("#geometry").css("background",offbuttoncolor);
        $("#geometry").css("color",offtextcolor);
        toolType = "graphing";
        window.rebuild();
      });
      $("#geometry").click(function(){
        $("#graphing").css("background",offbuttoncolor);
        $("#graphing").css("color",offtextcolor);
        $("#geometry").css("background",onbuttoncolor);
        $("#geometry").css("color",ontextcolor);
        toolType = "geometry";
        window.rebuild();
      });
      $("#copyState").click(function(){
        var currState = window.copyState();
        var field = $('#stateInput')[0];
        field.value = JSON.stringify(currState);
        field.focus()
        field.setSelectionRange(0,field.value.length);
        var succeed;
        try {
          succeed = document.execCommand('copy');
          alert('Calculator state copied to clipboard.');
        } catch(e) {
          succeed = false;
          alert('Failed to copy to clipboard. Select and copy manually from text field above \'Copy Current State\' button.');
        }
      });

      function loadFromInput(){
        var state;
        try {
          state = $.parseJSON($("#stateInput")[0].value);
        } catch (e) {
          alert('Failed to load state. Please input a valid Calculator or Geometry Tool state as output by the tool\'s \'getState()\' command.\n\nHint: A Calculator state will contain \"expressions\" and a Geometry Tool state will contain \"objects\".');
          return;
        }
        try {
          window.load(state);
        } catch (e) {
          alert('Failed to load state. Please input a valid Calculator or Geometry Tool state as output by the tool\'s \'getState()\' command.\n\nHint: A Calculator state will contain \"expressions\" and a Geometry Tool state will contain \"objects\".');
          return;
        }
      };

      $("#load").click(loadFromInput);

      $("#stateInput").keyup(function(e){
        if (e.keyCode == 13) loadFromInput();
      });

      var $frame = $('#frame');
      var $elt = $('#calculator');
      window.agaColors = {
        blue: '#0092C8',
        red: '#F15A22',
        green: '#0AB14B',
        teal: '#36C1CD',
        orange: '#EFA038',
        lime: '#95CA59',
        purple: '#812990',
        black: '#000000',
        grey: '#58595B'
      };
      var defaultGraphSettings = {
        degreeMode:true,
        xAxisArrowMode:Desmos.AxisArrowModes.BOTH,
        yAxisArrowMode:Desmos.AxisArrowModes.BOTH,
        xAxisLabel:"x",
        yAxisLabel:"y"
      };
      window.calcConstructors = {
        /*Comment indicates difference from default.*/
        /* default: graphpaper, expressions, settingsMenu, zoomButtons, expressionsTopbar, pointsOfInterest, singleVariableSolutions, trace, border, expressionsCollapsed, folders, notes, qwertyKeyboard, pasteTableData, degreeMode */
        default:{
          'keypad':false,
          'graphpaper':true,
          'expressions':true,
          'settingsMenu':true,
          'zoomButtons':true,
          'expressionsTopbar':true,
          'pointsOfInterest':true,
          'singleVariableSolutions':true,
          'trace':true,
          'border':true,
          'lockViewport':false,
          'expressionsCollapsed':true,
          'images':false,
          'folders':true,
          'notes':true,
          'qwertyKeyboard':true,
          'restrictedFunctions':false,
          'pasteGraphLink':false,
          'pasteTableData':true,
          'degreeMode':true,
          'colors':agaColors
        },
        /* allOff: */
        allOff:{
          'keypad':false,
          'graphpaper':false, /**/
          'expressions':false, /**/
          'settingsMenu':false, /**/
          'zoomButtons':false, /**/
          'expressionsTopbar':false, /**/
          'pointsOfInterest':false, /**/
          'singleVariableSolutions':false, /**/
          'trace':false, /**/
          'border':false, /**/
          'lockViewport':false,
          'expressionsCollapsed':false, /**/
          'images':false,
          'folders':false, /**/
          'notes':false, /**/
          'qwertyKeyboard':false, /**/
          'restrictedFunctions':false,
          'pasteGraphLink':false,
          'pasteTableData':false, /**/
          'degreeMode':false, /**/
          'colors':agaColors
        }
      }
      window.geoConstructors = {
        /* default: perpendicular, parallel, midpoint, compass, border, labels */
        default:{
          'construct.perpendicular':true,
          'construct.parallel':true,
          'construct.midpoint':true,
          'construct.compass':true,
          'border':true,
          'labels':true,
          'ruler':false,
          'protractor':false
        },
        /* allOff */
        allOff:{
          'construct.perpendicular':false,
          'construct.parallel':false,
          'construct.midpoint':false,
          'construct.compass':false,
          'border':false,
          'labels':false,
          'ruler':false,
          'protractor':false
        }
      }

      window.currentCalcConstructors = Object.assign({},window.calcConstructors.default,{administerSecretFolders:true});
      window.currentGeoConstructors = Object.assign({},window.geoConstructors.default);
      window.calculator = window.Calc = window.Geo = null;

      var toolType = 'graphing';
      var calcDefaultState = null;
      var geoDefaultState = null;
      var calcPrevState = null;
      var geoPrevState = null;

      // Note: never set toolType before refreshing the calculator;
      //       toolType should always match current toolType.
      function refreshCalculator(type = toolType) {

        window.calculator = null;
        if(window.Geo) {
          geoPrevState = window.Geo.getState();
          delete window.Geo;
        }
        if(window.Calc) {
          calcPrevState = window.Calc.getState();
          delete window.Calc;
        }
        if($elt) $elt.remove();

        // Build the frame and UI
        $frame.html('<div id="calculator" style="width:550px;height:475px;"></div>');
        $elt = $('#calculator');

        // Instantiate the calculator and set its state
        if (type == 'graphing') {
          window.calculator = window.Calc = Desmos.GraphingCalculator($elt[0], window.currentCalcConstructors);
          if (calcPrevState) window.calculator.setState(calcPrevState);
          else window.calculator.updateSettings(defaultGraphSettings);
          if (calcDefaultState) window.calculator.setDefaultState(calcDefaultState);
          else window.calculator.setDefaultState(window.calculator.getState());
        } else if (type == 'geometry') {
          window.calculator = window.Geo = Desmos.Geometry($elt[0], window.currentGeoConstructors);
          window.calculator.setState(geoPrevState);
          if (window.currentGeoConstructors.ruler) window.Geo.showRuler();
          if (window.currentGeoConstructors.protractor) window.Geo.showProtractor();
          // window.calculator.setDefaultState(geoDefaultState);
        };
        
        $elt.resizable({
          handles: 'e, s, se',
          grid: [5,5],
          resize: function(evt, ui) {
            var tail='';
            var h=ui.size.height;
            var w=ui.size.width;
            if (Math.abs(280-w)<15) {ui.size.width=w=280; tail+=' (1/3 Column)';}
            else if (Math.abs(415-w)<15) {ui.size.width=w=415; tail+=' (50% Column)';}
            else if (Math.abs(550-w)<15) {ui.size.width=w=550; tail+=' (2/3 Column)';}
            else if (Math.abs(860-w)<15) {ui.size.width=w=860; tail+=' (Full Column)';}
            if (Math.abs(475-h)<15) {ui.size.height=h=475; tail+=' (Height 1)';}
            else if (Math.abs(400-h)<15) {ui.size.height=h=400; tail+=' (Height 2)';}
            else if (Math.abs(350-h)<15) {ui.size.height=h=350; tail+=' (Height 3)';}
            console.log('' + w + ' × ' + h + tail);
          },
          stop: function(evt, ui) { 
            window.calculator.resize();
          }
        });

        toolType = type;
        updateView();
      }

      function updateView(type = toolType) {
        if (type == "geometry") {
          $("#graphing").css("background",offbuttoncolor);
          $("#graphing").css("color",offtextcolor);
          $("#geometry").css("background",onbuttoncolor);
          $("#geometry").css("color",ontextcolor);
        } else if (type == "graphing") {
          $("#graphing").css("background",onbuttoncolor);
          $("#graphing").css("color",ontextcolor);
          $("#geometry").css("background",offbuttoncolor);
          $("#geometry").css("color",offtextcolor);
        }
        var currentConstructors = ((type == "graphing")?currentCalcConstructors:currentGeoConstructors);
        if ((type == 'geometry') && (currentConstructors.ruler === undefined)) currentConstructors.ruler = false;
        if ((type == 'geometry') && (currentConstructors.protractor === undefined)) currentConstructors.protractor = false;

        if(toolType != type) {
          refreshCalculator(type);
        };
      }

      window.rebuild = function(options={}) {
        // Update the constructors
        var currentConstructors = ((toolType == "graphing")?currentCalcConstructors:currentGeoConstructors);
        for (arg in arguments) Object.assign(currentConstructors,arguments[arg]);
        refreshCalculator();
      };
      window.show = function(options={}) {
        if (toolType == 'graphing') {
          Object.assign(window.currentCalcConstructors,{'administerSecretFolders':true});
        };
        window.rebuild.apply(this,options);
      };
      window.load = function(state, options={remapColors:true,allowUndo:true}) {
        var type;
        if (state.expressions != undefined) {
          calcDefaultState = state;
          type = 'graphing';
        }
        if (state.objects != undefined) {
          geoDefaultState = state;
          type = 'geometry';
        }

        refreshCalculator(type);
        window.calculator.setState(state, options);
      };
      window.copyState = function() {
        var currState = window.calculator.getState();
        try {copy(JSON.stringify(currState));} catch(e) {};
        return currState;
      };

      window.show();
    });
  </script>
</body>
</html>